<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2015-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-plugin-WfsCluster'>/**
</span> * Plugin used for serversided (GeoServer SQL-View) Clustering. And clientsided
 * (OL3) styling.
 *
 * @class BasiGX.plugin.WfsCluster
 */
Ext.define('BasiGX.plugin.WfsCluster', {
    extend: 'Ext.plugin.Abstract',

    alias: 'plugin.wfscluster',
<span id='BasiGX-plugin-WfsCluster-cfg-pluginId'>    pluginId: 'wfscluster',
</span>
<span id='BasiGX-plugin-WfsCluster-method-init'>    init: function (cmp) {
</span>        var me = this;
        this.setCmp(cmp);

        me.setUpClusterLayers(this.getCmp());
    },

<span id='BasiGX-plugin-WfsCluster-method-setUpClusterLayers'>    setUpClusterLayers: function(mapComponent){
</span>        var me = this;
        var map = mapComponent.getMap();
        var allLayers = BasiGX.util.Layer.getAllLayers(map);
        var clusterLayers = [];

        Ext.each(allLayers, function(layer) {
            if (layer.get('type') === &quot;WFSCluster&quot;) {
                // register visibility listener to load the features when
                // layer is toggled in tree, which is not detected by the
                // maps moveend listener
                // TODO: check why this gets fired 2 times -&gt; geoext?!!
                if (!layer.visibilityListener) {
                    layer.on(&quot;change:visible&quot;, function(evt) {
                        if (evt.target.getVisible()) {
                            me.loadClusterFeatures(layer);
                        }
                    });
                }
                clusterLayers.push(layer);
                if(layer.get('olStyle')){
                    layer.setStyle(layer.get('olStyle'));
                } else {
                    layer.setStyle(me.clusterStyleFuntion);
                }
            }
        });

        if (clusterLayers.length &gt; 0) {
            // on every map move
            map.on('moveend', function() {
                me.loadClusterFeatures(clusterLayers);
            }, me);
        }
    },

<span id='BasiGX-plugin-WfsCluster-method-clusterStyleFuntion'>    clusterStyleFuntion: function(feature) {
</span>        var layerName;
        if(feature.getId()){
            layerName = feature.getId().split(&quot;.&quot;)[0];
        } else {
            layerName = feature.get('layerName');
        }

        var layer = BasiGX.util.Layer.getLayerByName(layerName);
        var count = feature.get('count'),
            radius,
            fontSize;

        if (count &gt; 10) {
            radius = 25;
            fontSize = 14;
        } else if (count &lt; 4) {
            fontSize = 7;
            radius = 8;
        } else {
            radius = count * 2;
            fontSize = count * 1.3;
        }
        return [
            new ol.style.Style({
                image: new ol.style.Circle({
                    radius: radius,
                    // opacity: 0.6,
                    fill: new ol.style.Fill({
                        color: layer.get('clusterColorString')
                    }),
                    stroke: new ol.style.Stroke({
                        color: 'gray'
                    })
                }),
                text: new ol.style.Text({
                    text: count &gt; 1 ? count.toString() : '',
                    font: 'bold ' + fontSize * 2 + 'px Arial',
                    stroke: new ol.style.Stroke({
                        color: 'black',
                        width: 1
                    }),
                    fill: new ol.style.Fill({color: 'white'})
                })
            })
        ];
    },

<span id='BasiGX-plugin-WfsCluster-method-loadClusterFeatures'>    /**
</span>     * The wfscluster layerType expects a geoserver view which handles
     * clustering with database methods
     */
    loadClusterFeatures: function(clusterLayers) {
        var me = this;
        var mapComponent = me.getCmp();
        var map = mapComponent.getMap();

        if (map &amp;&amp; map.getView() &amp;&amp; map.getView().getResolution() &amp;&amp;
            map.getSize()) {
            var res = map.getView().getResolution();
            var extent = map.getView().calculateExtent(map.getSize());
            // the factor which describes the distance used
            // to decide when to cluster. Unit is very
            // roughly ~meters.
            var factor = Math.round(res * 70);

            // when reaching the lower limit of 250, reduce /
            // disable clustering to see the real features
            if (factor &lt; 250) {
                factor = 1;
            }
            Ext.each(clusterLayers, function(layer) {
                if (layer.getVisible()) {
                    var featureType = layer.get('featureType');
                    var baseUrl = layer.get('url');
                    Ext.Ajax.request({
                        url: baseUrl + &quot;?service=WFS&amp;&quot; +
                            &quot;version=1.0.0&amp;&quot; +
                            &quot;request=GetFeature&amp;&quot; +
                            &quot;typeName=&quot; + featureType + &quot;&amp;&quot; +
                            &quot;outputFormat=application/json&amp;&quot; +
                            &quot;bbox=&quot; + extent.join(&quot;,&quot;) + &quot;&amp;&quot; +
                            &quot;viewParams=resolutioninm:&quot; + factor + &quot;;&quot; +
                            &quot;bboxllx:&quot; + extent[0] + &quot;;&quot; +
                            &quot;bboxlly:&quot; + extent[1] + &quot;;&quot; +
                            &quot;bboxurx:&quot; + extent[2] + &quot;;&quot; +
                            &quot;bboxury:&quot; + extent[3],
                        success: function(response){
                            var feats = response.responseText;
                            var f = new ol.format.GeoJSON().readFeatures(feats);
                            layer.getSource().clear();
                            layer.getSource().addFeatures(f);
                        },
                        failure: function(){
                            Ext.log.error(&quot;Failure on load of cluster features&quot;);
                        }
                    });
                }
            });
        }
    }
});
</pre>
</body>
</html>
