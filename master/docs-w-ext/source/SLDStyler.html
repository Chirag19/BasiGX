<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2017-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-view-container-SLDStyler'>/**
</span> * SLD Styler
 *
 * Used in combination with a GeoServer to edit SLD styles and preview
 * or save them
 *
 * @example:
 * var styleEditor = {
 *     xtype: &#39;basigx-container-sldstyler&#39;,
 *     backendUrls: {
 *        pictureList: {
 *            url: &#39;rest/images&#39;,
 *            method: &#39;GET&#39;
 *        },
 *        pictureSrc: {
 *            url: &#39;image/getThumbnail.action?id=&#39;
 *        },
 *        pictureUpload: {
 *            url: &#39;image/upload.action?&#39;
 *        },
 *        graphicDelete: {
 *            url: &#39;rest/images/&#39;,
 *            method: &#39;DELETE&#39;
 *        },
 *        geoServerUrl: BasiGX.util.Url.getWebProjectBaseUrl() +
 *            &#39;geoserver.action&#39;
 *     },
 *     layer: &#39;namespace:layer&#39;,
 *     sld: &#39;&lt;xml ...?&gt;&#39;,
 *     ruleName: &#39;rule1&#39;,
 *     mode: &#39;polygon&#39;
 * };
 *
 * @author Johannes Weskamm
 * @class BasiGX.view.container.SLDStyler
 */
Ext.define(&#39;BasiGX.view.container.SLDStyler&#39;, {
    extend: &#39;Ext.container.Container&#39;,
    xtype: &#39;basigx-container-sldstyler&#39;,

    requires: [
        &#39;Ext.ux.colorpick.Button&#39;,
        &#39;BasiGX.view.panel.GraphicPool&#39;,
        &#39;BasiGX.view.panel.FontSymbolPool&#39;,
        &#39;BasiGX.util.Color&#39;,
        &#39;BasiGX.util.SLD&#39;,
        &#39;BasiGX.util.Object&#39;
    ],

<span id='BasiGX-view-container-SLDStyler-cfg-viewModel'>    viewModel: {
</span>        data: {
            pointStyleFieldSetTitle: &#39;Point Style&#39;,
            pointStyleSymbolPanelTitle: &#39;Symbol&#39;,
            pointStyleRadiusNumberFieldLabel: &#39;Point Radius&#39;,
            pointStyleStrokeNumberFieldLabel: &#39;Stroke Width&#39;,
            pointStyleStrokeColorFieldLabel: &#39;Stroke Color&#39;,
            pointStyleFillColorFieldLabel: &#39;Fill Color&#39;,
            pointStyleGraphicPanelTitle: &#39;Graphic&#39;,
            pointStyleChooseImgBtnText: &#39;Choose Image&#39;,
            pointStyleChooseFontBtnText: &#39;Choose Font Symbol&#39;,
            pointStyleImgScaleSliderLabel: &#39;Scale&#39;,
            pointStyleImgRotationSliderLabel: &#39;Rotation&#39;,
            pointStyleImgOpacitySliderLabel: &#39;Opacity&#39;,
            lineStyleFieldSetTitle: &#39;LineString Style&#39;,
            lineStyleStrokeNumberFieldLabel: &#39;Stroke Width&#39;,
            lineStyleStrokeColorFieldLabel: &#39;Stroke Color&#39;,
            polygonStyleFieldSetTitle: &#39;Polygon Style&#39;,
            polygonStyleSymbolPanelTitle: &#39;Symbol&#39;,
            polygonStyleStrokeNumberFieldLabel: &#39;Stroke Width&#39;,
            polygonStyleStrokeColorFieldLabel: &#39;Stroke Color&#39;,
            polygonStyleFillColorFieldLabel: &#39;Fill Color&#39;,
            polygonStyleGraphicPanelTitle: &#39;Graphic&#39;,
            polygonStyleImgScaleSliderLabel: &#39;Scale&#39;,
            polygonStyleImgRotationSliderLabel: &#39;Rotation&#39;,
            polygonStyleImgOpacitySliderLabel: &#39;Opacity&#39;,
            pointGrapicDeletedSuccessMsgText: &#39;The icon has been deleted. &#39; +
                &#39;Please reassign a new one.&#39;,
            pointGrapicDeletedSuccessMsgTitle: &#39;Deletion succesfull&#39;,
            graphicPoolWindowTitle: &#39;Graphic Pool&#39;,
            fontSymbolPoolWindowTitle: &#39;Font symbol pool&#39;,
            documentation: &#39;&lt;h2&gt;SLD Styler&lt;/h2&gt;• Verwenden Sie den &#39; +
                &#39;SLD Styler, um Ihre Zeichenobjekte nach Wunsch zu gestalten.&#39; +
                &#39;&lt;br&gt;• Neben Farben, Strichstärken und Schrifteigenschaften &#39; +
                &#39;können auch eigene Icons für die Symbolisierung verwendet &#39; +
                &#39;werden&#39;
        }
    },

<span id='BasiGX-view-container-SLDStyler-property-padding'>    /**
</span>     *
     */
    padding: 5,

<span id='BasiGX-view-container-SLDStyler-property-config'>    /**
</span>     *
     */
    config: {
<span id='BasiGX-view-container-SLDStyler-cfg-backendUrls'>        /**
</span>         *
         */
        backendUrls: {
<span id='BasiGX-view-container-SLDStyler-property-pictureList'>            /**
</span>             * The URL to retrieve all images with resource link as JSON
             */
            pictureList: null,
<span id='BasiGX-view-container-SLDStyler-property-pictureSrc'>            /**
</span>             * The URL to retrieve an image as thumbnail
             */
            pictureSrc: null,
<span id='BasiGX-view-container-SLDStyler-property-pictureUpload'>            /**
</span>             * The URL to upload an image
             */
            pictureUpload: null,
<span id='BasiGX-view-container-SLDStyler-property-graphicDelete'>            /**
</span>             * The URL to delete an image
             */
            graphicDelete: null,
<span id='BasiGX-view-container-SLDStyler-property-geoServerUrl'>            /**
</span>             * The URL of the GeoServer to use
             */
            geoServerUrl: null,
<span id='BasiGX-view-container-SLDStyler-property-geoserverFontListUrl'>            /**
</span>             * The REST URL of the GeoServer to retrieve all available fonts.
             * E.g. http://localhost:8080/geoserver/rest/resource/fonts
             * would list all fonts from the GEOSERVER_DATA_DIR/fonts directory
             */
            geoserverFontListUrl: null,
<span id='BasiGX-view-container-SLDStyler-property-geoserverFontUrl'>            /**
</span>             * The REST URL of the GeoServer to retrieve a specific font. E.g.
             * http://localhost:8080/geoserver/rest/resource/fonts/Arial.ttf
             * would retrieve the specific font from the
             * GEOSERVER_DATA_DIR/fonts directory
             */
            geoserverFontUrl: null
        },
<span id='BasiGX-view-container-SLDStyler-cfg-mode'>        /**
</span>         * The mode indicates if we are styling a `point`, `line` or `polygon`
         */
        mode: &#39;point&#39;,

<span id='BasiGX-view-container-SLDStyler-cfg-layer'>        /**
</span>         * The full qualified layerName of the layer in GeoServer
         */
        layer: null,

<span id='BasiGX-view-container-SLDStyler-cfg-sld'>        /**
</span>         * The SLD this component shall use
         */
        sld: null,

<span id='BasiGX-view-container-SLDStyler-cfg-ruleName'>        /**
</span>         * The name of the rule of the SLD we want to handle
         */
        ruleName: null,

<span id='BasiGX-view-container-SLDStyler-cfg-rule'>        /**
</span>         * The rule Object. Gets set on update of style
         */
        rule: null,

<span id='BasiGX-view-container-SLDStyler-cfg-sldObj'>        /**
</span>         * The SLD javascript Object
         */
        sldObj: null
    },

<span id='BasiGX-view-container-SLDStyler-method-initComponent'>    /**
</span>     * @param {Object} config The configuration object for the SLD styler.
     */
    initComponent: function() {
        var sld = this.getSld();
        if (!sld) {
            Ext.log.warn(&#39;Component needs to be configured with a valid SLD&#39;);
            return;
        }
        this.callParent();
        this.setSldObj(BasiGX.util.SLD.toSldObject(sld));

        if (this.getMode() === &#39;point&#39;) {
            this.add(this.getPointFieldset());
        } else if (this.getMode() === &#39;line&#39;) {
            this.add(this.getLineStringFieldset());
        } else if (this.getMode() === &#39;polygon&#39;) {
            this.add(this.getPolygonFieldset());
        }

        // activate the graphic tab if necessary
        var usingExternalGraphic = false;
        var graphicOrMark = BasiGX.util.Object.getValue(
            &#39;externalGraphicOrMark&#39;, this.getSldObj());
        if (graphicOrMark &amp;&amp; graphicOrMark[0] &amp;&amp;
           (graphicOrMark[0].onlineResource ||
           (graphicOrMark[0].wellKnownName &amp;&amp;
            graphicOrMark[0].wellKnownName.content[0]
                .indexOf(&#39;ttf://&#39;) &gt; -1))) {
            usingExternalGraphic = true;
        }
        if (usingExternalGraphic) {
            var externalGrphicPanel = this.down(&#39;panel[name=graphic]&#39;);
            this.down(&#39;tabpanel&#39;).setActiveItem(externalGrphicPanel);
        }
        this.updateSLDPreview();
    },

<span id='BasiGX-view-container-SLDStyler-method-getPointFieldset'>    /**
</span>     * Returns a configuration object for an ExtJS fieldset for styling points
     * which can e.g. be used inside the `items` config.
     *
     * @return {Object} A configuration for an ExtJS fieldset for styling
     *     points.
     */
    getPointFieldset: function() {
        var me = this;
        var sldObj = me.getSldObj();
        var getVal = BasiGX.util.Object.getValue;
        var rule = BasiGX.util.SLD.getRuleByName(me.getRuleName(), sldObj);
        var listenerConfig = {
            change: me.updateSLDPreview,
            scope: me
        };

        if (!rule) {
            // take the first available rule to show an initial render
            // for e.g. new created rules that are not persisted yet
            var availableRules = BasiGX.util.SLD.rulesFromSldObject(sldObj);
            rule = availableRules[0];
        }

        var strokeWidth = BasiGX.util.SLD.DEFAULT_STROKE_WIDTH;
        var strokeOpacity = BasiGX.util.SLD.DEFAULT_STROKE_OPACITY;
        var strokeColor = BasiGX.util.SLD.DEFAULT_STROKE_COLOR;
        var fillColor = BasiGX.util.SLD.DEFAULT_FILL_COLOR;
        var fillOpacity = BasiGX.util.SLD.DEFAULT_FILL_OPACITY;
        var radius = BasiGX.util.SLD.DEFAULT_POINT_RADIUS;
        var graphicSize = BasiGX.util.SLD.DEFAULT_GRAPHIC_SIZE;
        var graphicOpacity = BasiGX.util.SLD.DEFAULT_GRAPHIC_OPACITY * 100;
        var graphicRotation = BasiGX.util.SLD.DEFAULT_GRAPHIC_ROTATION;
        var externalGraphicSrc = null;
        var fontAndUniCode = null;
        var alpha;

        var fill = getVal(&#39;fill&#39;, rule);
        var stroke = getVal(&#39;stroke&#39;, rule);
        var size = getVal(&#39;size&#39;, rule);
        var graphic = getVal(&#39;graphic&#39;, rule);

        if (fill) {
            fillColor = BasiGX.util.SLD.fillFromObj(fill).fillColor;
            fillOpacity = BasiGX.util.SLD.fillFromObj(fill).fillOpacity;
            alpha = BasiGX.util.Color.makeHex(&#39;&#39; +
                Math.round(parseFloat(fillOpacity) * 255));
            fillColor = fillColor + alpha;
        }

        if (stroke) {
            strokeWidth = BasiGX.util.SLD.strokeFromObj(stroke).strokeWidth;
            strokeOpacity = BasiGX.util.SLD.strokeFromObj(stroke).strokeOpacity;
            strokeColor = BasiGX.util.SLD.strokeFromObj(stroke).strokeColor;
            alpha = BasiGX.util.Color.makeHex(&#39;&#39; +
                Math.round(parseFloat(strokeOpacity) * 255));
            strokeColor = strokeColor + alpha;
        }

        if (size) {
            radius = parseInt(size.content[0], 10);
        }

        if (graphic) {
            if (getVal(&#39;size&#39;, graphic)) {
                graphicSize = getVal(&#39;size&#39;, graphic).content[0];
            }
            if (getVal(&#39;opacity&#39;, graphic)) {
                graphicOpacity = getVal(&#39;opacity&#39;, graphic).content[0] * 100;
            }
            if (getVal(&#39;rotation&#39;, graphic)) {
                graphicRotation = getVal(&#39;rotation&#39;, graphic).content[0];
            }
            if (getVal(&#39;href&#39;, graphic)) {
                externalGraphicSrc = getVal(&#39;href&#39;, graphic);
            }
            if (getVal(&#39;wellKnownName&#39;, graphic)) {
                var content = getVal(&#39;wellKnownName&#39;, graphic).content[0];
                if (content.indexOf(&#39;ttf://&#39;) &gt; -1) {
                    fontAndUniCode = getVal(&#39;wellKnownName&#39;, graphic)
                        .content[0];
                }
            }
        }

        var fs = {
            xtype: &#39;fieldset&#39;,
            bind: {
                title: &#39;{pointStyleFieldSetTitle}&#39;
            },
            name: &#39;pointstyle&#39;,
            layout: &#39;hbox&#39;,
            items: [{
                xtype: &#39;tabpanel&#39;,
                items: [{
                    xtype: &#39;panel&#39;,
                    bind: {
                        title: &#39;{pointStyleSymbolPanelTitle}&#39;
                    },
                    defaults: {
                        margin: 3,
                        width: 220
                    },
                    items: [{
                        xtype: &#39;numberfield&#39;,
                        bind: {
                            fieldLabel: &#39;{pointStyleRadiusNumberFieldLabel}&#39;
                        },
                        name: &#39;radius&#39;,
                        value: radius,
                        minValue: 1,
                        maxValue: 50,
                        listeners: listenerConfig
                    }, {
                        xtype: &#39;numberfield&#39;,
                        bind: {
                            fieldLabel: &#39;{pointStyleStrokeNumberFieldLabel}&#39;
                        },
                        name: &#39;stroke-width&#39;,
                        value: strokeWidth,
                        minValue: 0,
                        maxValue: 50,
                        listeners: listenerConfig
                    }, {
                        xtype: &#39;container&#39;,
                        layout: &#39;hbox&#39;,
                        defaults: {
                            width: 100
                        },
                        items: [{
                            xtype: &#39;displayfield&#39;,
                            width: 100,
                            bind: {
                                value: &#39;{pointStyleStrokeColorFieldLabel}&#39;
                            }
                        }, {
                            xtype: &#39;colorbutton&#39;,
                            name: &#39;stroke&#39;,
                            format: &#39;hex8&#39;,
                            value: strokeColor,
                            margin: &#39;5 0 0 10&#39;,
                            listeners: listenerConfig
                        }]
                    }, {
                        xtype: &#39;container&#39;,
                        layout: &#39;hbox&#39;,
                        defaults: {
                            width: 100
                        },
                        items: [{
                            xtype: &#39;displayfield&#39;,
                            width: 100,
                            bind: {
                                value: &#39;{pointStyleFillColorFieldLabel}&#39;
                            }
                        }, {
                            xtype: &#39;colorbutton&#39;,
                            name: &#39;fill&#39;,
                            format: &#39;hex8&#39;,
                            margin: &#39;0 0 0 10&#39;,
                            value: fillColor,
                            listeners: listenerConfig
                        }]
                    }]
                }, {
                    xtype: &#39;panel&#39;,
                    bind: {
                        title: &#39;{pointStyleGraphicPanelTitle}&#39;
                    },
                    name: &#39;graphic&#39;,
                    externalGraphicSrc: externalGraphicSrc,
                    fontAndUniCode: fontAndUniCode,
                    defaults: {
                        margin: 3,
                        width: 220
                    },
                    layout: &#39;vbox&#39;,
                    items: [{
                        xtype: &#39;button&#39;,
                        bind: {
                            text: &#39;{pointStyleChooseImgBtnText}&#39;
                        },
                        handler: me.onChooseGraphicClick,
                        scope: me
                    }, {
                        xtype: &#39;button&#39;,
                        bind: {
                            text: &#39;{pointStyleChooseFontBtnText}&#39;
                        },
                        handler: me.onChooseFontClick,
                        scope: me
                    }, {
                        xtype: &#39;slider&#39;,
                        bind: {
                            fieldLabel: &#39;{pointStyleImgOpacitySliderLabel}&#39;
                        },
                        name: &#39;graphic-opacity&#39;,
                        value: graphicOpacity,
                        disabled: fontAndUniCode ? true : false,
                        minValue: 0,
                        maxValue: 100,
                        increment: 10,
                        listeners: listenerConfig
                    }, {
                        xtype: &#39;slider&#39;,
                        bind: {
                            fieldLabel: &#39;{pointStyleImgRotationSliderLabel}&#39;
                        },
                        name: &#39;graphic-rotation&#39;,
                        value: graphicRotation,
                        minValue: 0,
                        maxValue: 360,
                        listeners: listenerConfig
                    }, {
                        xtype: &#39;slider&#39;,
                        bind: {
                            fieldLabel: &#39;{pointStyleImgScaleSliderLabel}&#39;
                        },
                        name: &#39;graphic-scale&#39;,
                        value: graphicSize,
                        increment: 1,
                        minValue: 1,
                        maxValue: 100,
                        listeners: listenerConfig
                    }, {
                        xtype: &#39;slider&#39;,
                        bind: {
                            fieldLabel: &#39;{pointStyleStrokeNumberFieldLabel}&#39;
                        },
                        name: &#39;stroke-width&#39;,
                        value: strokeWidth,
                        disabled: externalGraphicSrc ? true : false,
                        minValue: 0,
                        maxValue: 50,
                        listeners: listenerConfig
                    }, {
                        xtype: &#39;container&#39;,
                        layout: &#39;hbox&#39;,
                        defaults: {
                            width: 100
                        },
                        items: [{
                            xtype: &#39;displayfield&#39;,
                            disabled: externalGraphicSrc ? true : false,
                            width: 100,
                            bind: {
                                value: &#39;{pointStyleStrokeColorFieldLabel}&#39;
                            }
                        }, {
                            xtype: &#39;colorbutton&#39;,
                            disabled: externalGraphicSrc ? true : false,
                            name: &#39;stroke&#39;,
                            format: &#39;hex8&#39;,
                            value: strokeColor,
                            margin: &#39;5 0 0 10&#39;,
                            listeners: listenerConfig
                        }]
                    }, {
                        xtype: &#39;container&#39;,
                        layout: &#39;hbox&#39;,
                        disabled: externalGraphicSrc ? true : false,
                        defaults: {
                            width: 100
                        },
                        items: [{
                            xtype: &#39;displayfield&#39;,
                            disabled: externalGraphicSrc ? true : false,
                            width: 100,
                            bind: {
                                value: &#39;{pointStyleFillColorFieldLabel}&#39;
                            }
                        }, {
                            xtype: &#39;colorbutton&#39;,
                            disabled: externalGraphicSrc ? true : false,
                            name: &#39;fill&#39;,
                            format: &#39;hex8&#39;,
                            margin: &#39;0 0 0 10&#39;,
                            value: fillColor,
                            listeners: listenerConfig
                        }]
                    }]
                }]
            }, me.createSLDPreviewPanel()]
        };
        return fs;
    },

<span id='BasiGX-view-container-SLDStyler-method-getLineStringFieldset'>    /**
</span>     * Returns a configuration object for an ExtJS fieldset for styling
     * linestrings which can e.g. be used inside the `items` config.
     *
     * @return {Object} A configuration for an ExtJS fieldset for styling
     *     linestrings.
     */
    getLineStringFieldset: function() {
        var me = this;
        var sldObj = me.getSldObj();
        var getVal = BasiGX.util.Object.getValue;
        var rule = BasiGX.util.SLD.getRuleByName(me.getRuleName(), sldObj);
        var listenerConfig = {
            change: me.updateSLDPreview,
            scope: me
        };

        if (!rule) {
            // take the first available rule to show an initial render
            // for e.g. new created rules that are not persisted yet
            var availableRules = BasiGX.util.SLD.rulesFromSldObject(sldObj);
            rule = availableRules[0];
        }

        var strokeWidth = BasiGX.util.SLD.DEFAULT_STROKE_WIDTH;
        var strokeOpacity = BasiGX.util.SLD.DEFAULT_STROKE_OPACITY;
        var strokeColor = BasiGX.util.SLD.DEFAULT_STROKE_COLOR;

        var stroke = getVal(&#39;stroke&#39;, rule);

        if (stroke) {
            strokeWidth = BasiGX.util.SLD.strokeFromObj(stroke).strokeWidth;
            strokeOpacity = BasiGX.util.SLD.strokeFromObj(stroke).strokeOpacity;
            strokeColor = BasiGX.util.SLD.strokeFromObj(stroke).strokeColor;
            var alpha = BasiGX.util.Color.makeHex(&#39;&#39; +
                Math.round(parseFloat(strokeOpacity) * 255));
            strokeColor = strokeColor + alpha;
        }

        var fs = {
            xtype: &#39;fieldset&#39;,
            bind: {
                title: &#39;{lineStyleFieldSetTitle}&#39;
            },
            name: &#39;linestyle&#39;,
            layout: &#39;hbox&#39;,
            items: [{
                xtype: &#39;fieldset&#39;,
                layout: &#39;vbox&#39;,
                width: 220,
                defaults: {
                    margin: 3,
                    width: 180
                },
                items: [{
                    xtype: &#39;numberfield&#39;,
                    bind: {
                        fieldLabel: &#39;{lineStyleStrokeNumberFieldLabel}&#39;
                    },
                    value: strokeWidth,
                    name: &#39;stroke-width&#39;,
                    minValue: 0,
                    maxValue: 50,
                    listeners: listenerConfig
                }, {
                    xtype: &#39;container&#39;,
                    layout: &#39;hbox&#39;,
                    defaults: {
                        width: 100
                    },
                    items: [{
                        xtype: &#39;displayfield&#39;,
                        width: 100,
                        bind: {
                            value: &#39;{lineStyleStrokeColorFieldLabel}&#39;
                        }
                    }, {
                        xtype: &#39;colorbutton&#39;,
                        format: &#39;hex8&#39;,
                        value: strokeColor,
                        name: &#39;stroke&#39;,
                        margin: &#39;5 0 0 10&#39;,
                        listeners: listenerConfig
                    }]
                }]
            }, me.createSLDPreviewPanel()]
        };
        return fs;
    },

<span id='BasiGX-view-container-SLDStyler-method-getPolygonFieldset'>    /**
</span>     * Returns a configuration object for an ExtJS fieldset for styling
     * polygons which can e.g. be used inside the `items` config.
     *
     * @return {Object} A configuration for an ExtJS fieldset for styling
     *     polygon.
     */
    getPolygonFieldset: function() {
        var me = this;
        var sldObj = me.getSldObj();
        var getVal = BasiGX.util.Object.getValue;
        var rule = BasiGX.util.SLD.getRuleByName(me.getRuleName(), sldObj);
        var listenerConfig = {
            change: me.updateSLDPreview,
            scope: me
        };

        if (!rule) {
            // take the first available rule to show an initial render
            // for e.g. new created rules that are not persisted yet
            var availableRules = BasiGX.util.SLD.rulesFromSldObject(sldObj);
            rule = availableRules[0];
        }

        var strokeWidth = BasiGX.util.SLD.DEFAULT_STROKE_WIDTH;
        var strokeOpacity = BasiGX.util.SLD.DEFAULT_STROKE_OPACITY;
        var strokeColor = BasiGX.util.SLD.DEFAULT_STROKE_COLOR;
        var fillColor = BasiGX.util.SLD.DEFAULT_FILL_COLOR;
        var fillOpacity = BasiGX.util.SLD.DEFAULT_FILL_OPACITY;
        var graphicSize = BasiGX.util.SLD.DEFAULT_GRAPHIC_SIZE;
        var graphicOpacity = BasiGX.util.SLD.DEFAULT_GRAPHIC_OPACITY * 100;
        var graphicRotation = BasiGX.util.SLD.DEFAULT_GRAPHIC_ROTATION;
        var externalGraphicSrc = null;
        var fontAndUniCode = null;
        var alpha;

        var fill = getVal(&#39;fill&#39;, rule);
        var stroke = getVal(&#39;stroke&#39;, rule);
        var graphic = getVal(&#39;graphic&#39;, rule);

        if (fill) {
            fillColor = BasiGX.util.SLD.fillFromObj(fill).fillColor;
            fillOpacity = BasiGX.util.SLD.fillFromObj(fill).fillOpacity;
            alpha = BasiGX.util.Color.makeHex(&#39;&#39; +
                Math.round(parseFloat(fillOpacity) * 255));
            fillColor = fillColor + alpha;
        }

        if (stroke) {
            strokeWidth = BasiGX.util.SLD.strokeFromObj(stroke).strokeWidth;
            strokeOpacity = BasiGX.util.SLD.strokeFromObj(stroke).strokeOpacity;
            strokeColor = BasiGX.util.SLD.strokeFromObj(stroke).strokeColor;
            alpha = BasiGX.util.Color.makeHex(&#39;&#39; +
                Math.round(parseFloat(strokeOpacity) * 255));
            strokeColor = strokeColor + alpha;
        }

        if (graphic) {
            if (getVal(&#39;size&#39;, graphic)) {
                graphicSize = getVal(&#39;size&#39;, graphic).content[0];
            }
            if (getVal(&#39;opacity&#39;, graphic)) {
                graphicOpacity = getVal(&#39;opacity&#39;, graphic).content[0] * 100;
            }
            if (getVal(&#39;rotation&#39;, graphic)) {
                graphicRotation = getVal(&#39;rotation&#39;, graphic).content[0];
            }
            if (getVal(&#39;href&#39;, graphic)) {
                externalGraphicSrc = getVal(&#39;href&#39;, graphic);
            }
            if (getVal(&#39;wellKnownName&#39;, graphic)) {
                var content = getVal(&#39;wellKnownName&#39;, graphic).content[0];
                if (content.indexOf(&#39;ttf://&#39;) &gt; -1) {
                    fontAndUniCode = getVal(&#39;wellKnownName&#39;, graphic)
                        .content[0];
                }
            }
        }

        var fs = {
            xtype: &#39;fieldset&#39;,
            bind: {
                title: &#39;{polygonStyleFieldSetTitle}&#39;
            },
            name: &#39;polygonstyle&#39;,
            layout: &#39;hbox&#39;,
            items: [{
                xtype: &#39;tabpanel&#39;,
                items: [{
                    xtype: &#39;panel&#39;,
                    bind: {
                        title: &#39;{polygonStyleSymbolPanelTitle}&#39;
                    },
                    layout: &#39;vbox&#39;,
                    width: 220,
                    defaults: {
                        margin: 3,
                        width: 210
                    },
                    items: [{
                        xtype: &#39;numberfield&#39;,
                        bind: {
                            fieldLabel: &#39;{polygonStyleStrokeNumberFieldLabel}&#39;
                        },
                        value: strokeWidth,
                        name: &#39;stroke-width&#39;,
                        minValue: 0,
                        maxValue: 50,
                        listeners: listenerConfig
                    }, {
                        xtype: &#39;container&#39;,
                        layout: &#39;hbox&#39;,
                        defaults: {
                            width: 100
                        },
                        items: [{
                            xtype: &#39;displayfield&#39;,
                            width: 100,
                            bind: {
                                value: &#39;{polygonStyleStrokeColorFieldLabel}&#39;
                            }
                        }, {
                            xtype: &#39;colorbutton&#39;,
                            format: &#39;hex8&#39;,
                            value: strokeColor,
                            name: &#39;stroke&#39;,
                            margin: &#39;5 0 0 10&#39;,
                            listeners: listenerConfig
                        }]
                    }, {
                        xtype: &#39;container&#39;,
                        layout: &#39;hbox&#39;,
                        defaults: {
                            width: 100
                        },
                        items: [{
                            xtype: &#39;displayfield&#39;,
                            width: 100,
                            bind: {
                                value: &#39;{polygonStyleFillColorFieldLabel}&#39;
                            }
                        }, {
                            xtype: &#39;colorbutton&#39;,
                            format: &#39;hex8&#39;,
                            margin: &#39;0 0 0 10&#39;,
                            value: fillColor,
                            name: &#39;fill&#39;,
                            listeners: listenerConfig
                        }]
                    }]
                }, {
                    xtype: &#39;panel&#39;,
                    bind: {
                        title: &#39;{polygonStyleGraphicPanelTitle}&#39;
                    },
                    name: &#39;graphic&#39;,
                    layout: &#39;vbox&#39;,
                    externalGraphicSrc: externalGraphicSrc,
                    fontAndUniCode: fontAndUniCode,
                    defaults: {
                        margin: 3,
                        width: 210
                    },
                    items: [{
                        xtype: &#39;button&#39;,
                        bind: {
                            text: &#39;{pointStyleChooseImgBtnText}&#39;
                        },
                        handler: me.onChooseGraphicClick,
                        scope: me
                    }, {
                        xtype: &#39;button&#39;,
                        bind: {
                            text: &#39;{pointStyleChooseFontBtnText}&#39;
                        },
                        handler: me.onChooseFontClick,
                        scope: me
                    },
                    // opacity seems to be unsupported for external graphics /
                    // graphic fills, although its valid in SLD.
                    {
                        xtype: &#39;slider&#39;,
                        bind: {
                            fieldLabel: &#39;{polygonStyleImgOpacitySliderLabel}&#39;
                        },
                        name: &#39;graphic-opacity&#39;,
                        value: graphicOpacity,
                        disabled: true,
                        minValue: 0,
                        maxValue: 100,
                        increment: 10,
                        listeners: listenerConfig
                    },
                    {
                        xtype: &#39;slider&#39;,
                        bind: {
                            fieldLabel: &#39;{polygonStyleImgRotationSliderLabel}&#39;
                        },
                        name: &#39;graphic-rotation&#39;,
                        value: graphicRotation,
                        disabled: externalGraphicSrc ? true : false,
                        minValue: 0,
                        maxValue: 360,
                        listeners: listenerConfig
                    }, {
                        xtype: &#39;slider&#39;,
                        bind: {
                            fieldLabel: &#39;{polygonStyleImgScaleSliderLabel}&#39;
                        },
                        name: &#39;graphic-scale&#39;,
                        value: graphicSize,
                        increment: 1,
                        minValue: 1,
                        maxValue: 200,
                        listeners: listenerConfig
                    }, {
                        xtype: &#39;slider&#39;,
                        bind: {
                            fieldLabel: &#39;{polygonStyleStrokeNumberFieldLabel}&#39;
                        },
                        name: &#39;stroke-width&#39;,
                        value: strokeWidth,
                        disabled: externalGraphicSrc ? true : false,
                        minValue: 0,
                        maxValue: 10,
                        listeners: listenerConfig
                    }, {
                        xtype: &#39;container&#39;,
                        layout: &#39;hbox&#39;,
                        defaults: {
                            width: 100
                        },
                        items: [{
                            xtype: &#39;displayfield&#39;,
                            disabled: externalGraphicSrc ? true : false,
                            width: 100,
                            bind: {
                                value: &#39;{polygonStyleStrokeColorFieldLabel}&#39;
                            }
                        }, {
                            xtype: &#39;colorbutton&#39;,
                            disabled: externalGraphicSrc ? true : false,
                            name: &#39;stroke&#39;,
                            format: &#39;hex8&#39;,
                            value: strokeColor,
                            margin: &#39;5 0 0 10&#39;,
                            listeners: listenerConfig
                        }]
                    }, {
                        xtype: &#39;container&#39;,
                        layout: &#39;hbox&#39;,
                        defaults: {
                            width: 100
                        },
                        items: [{
                            xtype: &#39;displayfield&#39;,
                            disabled: externalGraphicSrc ? true : false,
                            width: 100,
                            bind: {
                                value: &#39;{polygonStyleFillColorFieldLabel}&#39;
                            }
                        }, {
                            xtype: &#39;colorbutton&#39;,
                            disabled: externalGraphicSrc ? true : false,
                            name: &#39;fill&#39;,
                            format: &#39;hex8&#39;,
                            margin: &#39;0 0 0 10&#39;,
                            value: fillColor,
                            listeners: listenerConfig
                        }]
                    }]
                }]
            }, me.createSLDPreviewPanel()]
        };
        return fs;
    },

<span id='BasiGX-view-container-SLDStyler-method-createSLDPreviewPanel'>    /**
</span>     * Creates an image-panel to preview the current SLD
     *
     * @return {Object} An ExtJS configuration object for the image panel
     */
    createSLDPreviewPanel: function() {
        var panel = {
            xtype: &#39;image&#39;,
            name: &#39;sldpreview-&#39; + this.getMode(),
            src: null,
            width: 200,
            minHeight: 80
        };
        return panel;
    },

<span id='BasiGX-view-container-SLDStyler-method-updateSLDPreview'>    /**
</span>     * Method updates the SLD Preview with the current state of the form values
     */
    updateSLDPreview: function() {
        var me = this;
        var selector = &#39;image[name=sldpreview-&#39; + this.getMode() + &#39;]&#39;;
        var imagePanel = Ext.ComponentQuery.query(selector)[0];

        var sld = me.getSldFromFormValues();
        var ruleName = me.getRuleName();
        var layer = me.getLayer();
        var geoServerUrl = me.getBackendUrls().geoServerUrl;

        if (imagePanel) {
            Ext.Ajax.request({
                binary: true,
                url: geoServerUrl,
                method: &#39;POST&#39;,
                params: {
                    service: &#39;WMS&#39;,
                    request: &#39;GetLegendGraphic&#39;,
                    layer: layer,
                    version: &#39;1.1.1&#39;,
                    format: &#39;image/png&#39;,
                    width: 190,
                    height: 190,
                    rule: ruleName,
                    sld_body: sld
                },
                defaultHeaders: BasiGX.util.CSRF.getHeader(),
                scope: this,
                success: function(response) {
                    var blob = new Blob(
                        [response.responseBytes],
                        {type: &#39;image/png&#39;}
                    );
                    var url = window.URL.createObjectURL(blob);
                    imagePanel.setSrc(url);
                },
                failure: function() {
                    Ext.toast(&#39;Error retrieving the SLD-Graphic preview&#39;);
                }
            });
        }
    },

<span id='BasiGX-view-container-SLDStyler-method-getSldFromFormValues'>    /**
</span>     * Method transforms the current form values into a valid SLD string,
     * which is then used to preview the current style with the help of an
     * `GetLegendGraphic` request issued against the GeoServer
     *
     * @return {String} sld The SLD string representing the current state of
     *     the form values
     */
    getSldFromFormValues: function() {
        var me = this;
        var selector = &#39;fieldset[name=&#39; + this.getMode() + &#39;style]&#39;;
        var fs = Ext.ComponentQuery.query(selector)[0];
        var sldObj = this.getSldObj();
        var value;
        if (!fs || !sldObj) {
            return &#39;&#39;;
        }

        var radiusFs = fs.down(&#39;[name=radius]&#39;);
        var graphicTab = fs.down(&#39;[name=graphic]&#39;);
        var graphicTabActive = false;

        if (graphicTab) {
            var activeTab = graphicTab.up(&#39;tabpanel&#39;).getActiveTab();
            if (activeTab === graphicTab) {
                graphicTabActive = true;
            }
        }

        var fillFs = graphicTabActive ? graphicTab.down(&#39;[name=fill]&#39;) :
            fs.down(&#39;[name=fill]&#39;);
        var strokeFs = graphicTabActive ? graphicTab.down(&#39;[name=stroke]&#39;) :
            fs.down(&#39;[name=stroke]&#39;);
        var strokeWidthFs = graphicTabActive ?
            graphicTab.down(&#39;[name=stroke-width]&#39;) :
            fs.down(&#39;[name=stroke-width]&#39;);

        var symbolizerObj = {};

        if (fillFs) {
            symbolizerObj.fillColor = &#39;#&#39; + fillFs.getValue().substring(0, 6);
            symbolizerObj.fillOpacity = BasiGX.util.Color.rgbaAsArray(
                BasiGX.util.Color.hex8ToRgba(fillFs.getValue()))[4];
        }

        if (strokeFs) {
            symbolizerObj.strokeColor = &#39;#&#39; + strokeFs.getValue()
                .substring(0, 6);
            symbolizerObj.strokeOpacity = BasiGX.util.Color.rgbaAsArray(
                BasiGX.util.Color.hex8ToRgba(strokeFs.getValue()))[4];
        }

        if (strokeWidthFs) {
            value = strokeWidthFs.getValue();
            symbolizerObj.strokeWidth = value ? value.toString() :
                BasiGX.util.SLD.DEFAULT_STROKE_WIDTH.toString();
        }

        if (!graphicTabActive &amp;&amp; radiusFs) {
            value = radiusFs.getValue();
            symbolizerObj.radius = value ? value.toString() :
                BasiGX.util.SLD.DEFAULT_POINT_RADIUS.toString();
        }

        if (graphicTabActive) {
            // only write external graphic or font values when the graphic
            // tab is active
            var scale = graphicTab.down(&#39;[name=graphic-scale]&#39;).getValue();
            var opacity = graphicTab.down(&#39;[name=graphic-opacity]&#39;)
                .getValue() / 100;
            var rotation = graphicTab.down(&#39;[name=graphic-rotation]&#39;)
                .getValue();
            if (graphicTab.externalGraphicSrc) {
                symbolizerObj.externalGraphicSrc = graphicTab
                    .externalGraphicSrc;
            }
            if (graphicTab.fontAndUniCode) {
                symbolizerObj.fontAndUniCode = graphicTab.fontAndUniCode;
            }
            symbolizerObj.graphicSize = scale ? scale.toString() :
                BasiGX.util.SLD.DEFAULT_GRAPHIC_SIZE.toString();
            symbolizerObj.graphicOpacity = opacity ? opacity.toString() :
                BasiGX.util.SLD.DEFAULT_GRAPHIC_OPACITY.toString();
            symbolizerObj.graphicRotation = rotation ? rotation.toString() :
                BasiGX.util.SLD.DEFAULT_GRAPHIC_ROTATION.toString();
        }

        if (this.getMode() === &#39;point&#39;) {
            sldObj = BasiGX.util.SLD.setPointSymbolizerInRule(
                symbolizerObj,
                me.getRuleName(),
                sldObj
            );
        } else if (this.getMode() === &#39;line&#39;) {
            sldObj = BasiGX.util.SLD.setLineSymbolizerInRule(
                symbolizerObj,
                me.getRuleName(),
                sldObj
            );
        } else if (this.getMode() === &#39;polygon&#39;) {
            sldObj = BasiGX.util.SLD.setPolygonSymbolizerInRule(
                symbolizerObj,
                me.getRuleName(),
                sldObj
            );
        }

        var sld = BasiGX.util.SLD.toSldString(sldObj);

        // update our properties
        me.setSld(sld);
        me.setRule(BasiGX.util.SLD.getRuleByName(me.getRuleName(), sldObj));
        me.setSldObj(sldObj);

        return sld;

    },

<span id='BasiGX-view-container-SLDStyler-method-onChooseFontClick'>    /**
</span>     * Creates and shows a window with a `BasiGX.view.panel.FontSymbolPool`,
     * that allows the user to pick a font and symbol for setting a ttf mark
     * in the sld
     */
    onChooseFontClick: function() {
        var me = this;
        var callbackFn = function(fullQualifiedGlyphName) {
            var graphicFs = me.down(&#39;[name=graphic]&#39;);
            graphicFs.fontAndUniCode = fullQualifiedGlyphName;
            // unset an potential external graphic
            graphicFs.externalGraphicSrc = null;
            // set matching style options
            if (me.getMode() === &#39;point&#39;) {
                graphicFs.down(&#39;[name=graphic-opacity]&#39;).setDisabled(true);
            }
            if (me.getMode() === &#39;polygon&#39;) {
                graphicFs.down(&#39;[name=graphic-rotation]&#39;).setDisabled(false);
            }
            graphicFs.down(&#39;[name=fill]&#39;).setDisabled(false);
            graphicFs.down(&#39;[name=stroke]&#39;).setDisabled(false);
            graphicFs.down(&#39;[name=stroke-width]&#39;).setDisabled(false);
            graphicFs.down(&#39;[name=stroke-width]&#39;).setValue(1);
            me.updateSLDPreview();
        };

        // cleanup
        var selector = &#39;window[title=&#39; +
            me.getViewModel().get(&#39;fontSymbolPoolWindowTitle&#39;) + &#39;]&#39;;
        var wins = Ext.ComponentQuery.query(selector);
        Ext.each(wins, function(win) {
            win.destroy();
        });

        var fontSymbolPool = Ext.create(&#39;BasiGX.view.panel.FontSymbolPool&#39;, {
            geoserverFontListUrl: me.getBackendUrls().geoserverFontListUrl,
            geoserverFontUrl: me.getBackendUrls().geoserverFontUrl,
            useCsrfToken: true,
            onGlyphSelected: callbackFn
        });

        var fontSymbolPoolWin = Ext.create(&#39;Ext.window.Window&#39;, {
            title: me.getViewModel().get(&#39;fontSymbolPoolWindowTitle&#39;),
            constrained: true,
            items: [fontSymbolPool]
        });
        fontSymbolPoolWin.showAt(5, 5);
    },

<span id='BasiGX-view-container-SLDStyler-method-onChooseGraphicClick'>    /**
</span>     * Creates and shows a window with a `BasiGX.view.panel.GraphicPool`, that
     * will eventually update both the preview and also the styles in the
     * attached layer.
     */
    onChooseGraphicClick: function() {
        var me = this;
        var okClickCallbackFn = function(pictureRec) {
            var pictureUrl = BasiGX.util.Url.getWebProjectBaseUrl() +
                me.getBackendUrls().pictureSrc.url +
                pictureRec.get(&#39;id&#39;);
            var graphicFs = me.down(&#39;[name=graphic]&#39;);
            graphicFs.externalGraphicSrc = pictureUrl;
            // unset an potential font and glyph
            graphicFs.fontAndUniCode = null;
            // set matching style options
            if (me.getMode() === &#39;point&#39;) {
                graphicFs.down(&#39;[name=graphic-opacity]&#39;).setDisabled(false);
            }
            if (me.getMode() === &#39;polygon&#39;) {
                graphicFs.down(&#39;[name=graphic-rotation]&#39;).setDisabled(true);
            }
            graphicFs.down(&#39;[name=fill]&#39;).setDisabled(true);
            graphicFs.down(&#39;[name=stroke]&#39;).setDisabled(true);
            graphicFs.down(&#39;[name=stroke-width]&#39;).setDisabled(true);
            me.updateSLDPreview();
        };

        var deleteClickCallbackFn = function() {
            Ext.toast(
                me.getViewModel().get(&#39;pointGrapicDeletedSuccessMsgText&#39;),
                me.getViewModel().get(&#39;pointGrapicDeletedSuccessMsgTitle&#39;),
                &#39;t&#39;
            );
        };

        var graphicPool = Ext.create(&#39;BasiGX.view.panel.GraphicPool&#39;, {
            backendUrls: me.getBackendUrls(),
            okClickCallbackFn: okClickCallbackFn,
            deleteClickCallbackFn: deleteClickCallbackFn,
            useCsrfToken: true
        });

        var graphicPoolWin = Ext.create(&#39;Ext.window.Window&#39;, {
            title: me.getViewModel().get(&#39;graphicPoolWindowTitle&#39;),
            constrained: true,
            items: [graphicPool]
        });
        graphicPoolWin.show();
    }
});
</pre>
</body>
</html>
