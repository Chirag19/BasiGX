<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2017-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-view-panel-FontSymbolPool'>/**
</span> *
 * BasiGX.view.panel.FontSymbolPool
 *
 * Used to display the available fonts and their symbols available in
 * the geoserver. Enables user to select a symbol for e.g. SLD styling
 *
 * @class BasiGX.view.panel.FontSymbolPool
 */
Ext.define(&#39;BasiGX.view.panel.FontSymbolPool&#39;, {
    extend: &#39;Ext.panel.Panel&#39;,
    xtype: &#39;basigx-panel-fontsymbolpool&#39;,

    requires: [
        &#39;BasiGX.util.Url&#39;,
        &#39;BasiGX.util.CSRF&#39;,
        &#39;BasiGX.util.MsgBox&#39;,
        &#39;BasiGX.view.panel.TtfGlyphInspector&#39;
    ],

<span id='BasiGX-view-panel-FontSymbolPool-property-viewModel'>    /**
</span>     *
     */
    viewModel: {
        data: {
            closeBtnText: &#39;Close&#39;,
            fontSelectLabel: &#39;Select a font&#39;,
            documentation: &#39;&lt;h2&gt;Zeichensatz Sammlung&lt;/h2&gt;• In diesem Dialog &#39; +
                &#39;kann für die Darstellung von Objekten ein Zeichen einer &#39; +
                &#39;Schriftart gewählt werden.&lt;br&gt;• Wählen Sie zunächst eine &#39; +
                &#39;Schriftart aus.&lt;br&gt;• Anschließend können Sie aus der &#39; +
                &#39;Zeichentabelle ein Symbol auswählen, dass zur Darstellung &#39; +
                &#39;verwendet werden soll&#39;
        }
    },

<span id='BasiGX-view-panel-FontSymbolPool-property-padding'>    /**
</span>     * global padding
     */
    padding: 5,

<span id='BasiGX-view-panel-FontSymbolPool-property-width'>    /**
</span>     * a default width for this component
     */
    width: 535,

<span id='BasiGX-view-panel-FontSymbolPool-property-height'>    /**
</span>     * a default height for this component
     */
    height: 600,

<span id='BasiGX-view-panel-FontSymbolPool-property-layout'>    /**
</span>     * the layout to use
     */
    layout: &#39;vbox&#39;,

<span id='BasiGX-view-panel-FontSymbolPool-property-config'>    /**
</span>     *
     */
    config: {
<span id='BasiGX-view-panel-FontSymbolPool-cfg-geoserverFontListUrl'>        /**
</span>         * The REST URL of the GeoServer to retrieve all available fonts.
         * E.g. http://localhost:8080/geoserver/rest/resource/fonts
         * would list all fonts from the GEOSERVER_DATA_DIR/fonts directory
         */
        geoserverFontListUrl: null,

<span id='BasiGX-view-panel-FontSymbolPool-cfg-geoserverFontUrl'>        /**
</span>         * The REST URL of the GeoServer to retrieve a specific font. E.g.
         * http://localhost:8080/geoserver/rest/resource/fonts/Arial.ttf
         * would retrieve the specific font from the
         * GEOSERVER_DATA_DIR/fonts directory
         */
        geoserverFontUrl: null,

<span id='BasiGX-view-panel-FontSymbolPool-cfg-useCsrfToken'>        /**
</span>         * flag that indicates that a csrf-token should be sent to backend
         * interfaces on every ajax / form submit.
         */
        useCsrfToken: false,

<span id='BasiGX-view-panel-FontSymbolPool-cfg-onGlyphSelected'>        /**
</span>         * function that should be called when a glyph has been selected
         */
        onGlyphSelected: null,

<span id='BasiGX-view-panel-FontSymbolPool-cfg-useCloseButton'>        /**
</span>         * should we offer a close button? Will close a parent window if
         * one exists
         */
        useCloseButton: true,

<span id='BasiGX-view-panel-FontSymbolPool-cfg-fontBlobUrl'>        /**
</span>         * The current ttf font object url to use as blob converted Uint8Array
         */
        fontBlobUrl: null,

<span id='BasiGX-view-panel-FontSymbolPool-cfg-selectedFontName'>        /**
</span>         * The name of the currently selected font
         */
        selectedFontName: null
    },

<span id='BasiGX-view-panel-FontSymbolPool-method-initComponent'>    /**
</span>     *
     */
    initComponent: function() {
        var me = this;

        // retrieve the available fonts from GeoServer via REST
        var store = Ext.create(&#39;Ext.data.Store&#39;, {
            sorters: &#39;fontName&#39;,
            fields: [
                &#39;name&#39;
            ],
            proxy: {
                type: &#39;ajax&#39;,
                url: me.getGeoserverFontListUrl(),
                reader: {
                    type: &#39;json&#39;,
                    rootProperty: &#39;ResourceDirectory.children.child&#39;
                }
            }
        });
        store.load();

        me.items = [{
            xtype: &#39;combo&#39;,
            width: 400,
            store: store,
            bind: {
                fieldLabel: &#39;{fontSelectLabel}&#39;
            },
            displayField: &#39;name&#39;,
            queryMode: &#39;local&#39;,
            listeners: {
                change: me.fontSelected
            }
        }];

        me.bbar = [
            &#39;-&gt;&#39;,
            {
                bind: {
                    text: &#39;{closeBtnText}&#39;
                },
                scope: me,
                handler: me.onCloseButtonClick,
                hidden: !me.getUseCloseButton()
            }
        ];

        me.callParent();
    },

<span id='BasiGX-view-panel-FontSymbolPool-method-fontSelected'>    /**
</span>     * Method retrieves a TrueTypeFont in binary mode from the GeoServer
     * in order to render its glyphs on the client side.
     *
     * @param {Object} combo The combobox that fired the event.
     * @param {String} fontName The name of the font that has been selected.
     */
    fontSelected: function(combo, fontName) {
        var symbolPool = this.up(&#39;basigx-panel-fontsymbolpool&#39;);
        var selectedRecord = combo.getSelectedRecord();
        var ttfHref = selectedRecord.getData().link.href;
        symbolPool.setSelectedFontName(fontName);

        if (ttfHref) {
            Ext.Ajax.request({
                binary: true,
                url: symbolPool.getGeoserverFontUrl(),
                method: &#39;GET&#39;,
                params: {
                    fontName: fontName
                },
                defaultHeaders: BasiGX.util.CSRF.getHeader(),
                scope: this,
                success: function(response) {
                    var blob = new Blob(
                        [response.responseBytes],
                        {type: &#39;application/octet-stream&#39;}
                    );
                    var url = window.URL.createObjectURL(blob);
                    symbolPool.setFontBlobUrl(url);
                    symbolPool.renderSymbols();
                },
                failure: function() {
                    Ext.toast(&#39;Error retrieving the Graphic preview&#39;);
                }
            });
        }
    },

<span id='BasiGX-view-panel-FontSymbolPool-method-renderSymbols'>    /**
</span>     * Method renders the available glyphs of a TrueTypeFont by instantiating
     * &#39;BasiGX.view.panel.TtfGlyphInspector&#39; with the font-blob. If a glyph
     * has been clicked by the user, the given callBack function will be called.
     */
    renderSymbols: function() {
        var me = this;
        // cleanup
        var panels = me.query(&#39;basigx-panel-ttfglyphinspector&#39;);
        Ext.each(panels, function(panel) {
            panel.destroy();
        });
        var glyphPanel = Ext.create(&#39;BasiGX.view.panel.TtfGlyphInspector&#39;, {
            fontSrc: this.getFontBlobUrl()
        });
        this.add(glyphPanel);
        glyphPanel.on(&#39;glyphSelected&#39;, function(fullQualifiedGlyphName) {
            me.getOnGlyphSelected().call(me, fullQualifiedGlyphName);
        });
    },

<span id='BasiGX-view-panel-FontSymbolPool-method-onCloseButtonClick'>    /**
</span>     * Method closes the window where this panel is embedded, if any.
     */
    onCloseButtonClick: function() {
        var me = this;
        if (me.up(&#39;window&#39;)) {
            me.up(&#39;window&#39;).close();
        }
    }
});
</pre>
</body>
</html>
