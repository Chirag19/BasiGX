<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2016-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-util-Filter'>/**
</span> * Utility class containing static methods to create a filter encoding objects
 * depending on given layer attribute filter configuration.
 *
 * @class BasiGX.util.Filter
 */
Ext.define(&#39;BasiGX.util.Filter&#39;, {

    statics: {

<span id='BasiGX-util-Filter-static-method-filterContentToWholeSimpleFilter'>        /**
</span>         * This method will be used to create a whole filter encoding string
         * for given filter content by adding of `&lt;ogc:Filter&gt;` tag around of
         * filter itself.
         *
         * @param {Object} filterContent Jsonix conform filter content value
         *     object.
         * @return {Object} An object representing a simple OGC filter 1.0.0;
         *     ready to be stringified using Jsonix.
         */
        filterContentToWholeSimpleFilter: function(filterContent) {
            return {
                value: filterContent,
                name: {
                    namespaceURI: &#39;http://www.opengis.net/ogc&#39;,
                    localPart: &#39;Filter&#39;,
                    prefix: &#39;ogc&#39;,
                    key: &#39;{http://www.opengis.net/ogc}Filter&#39;,
                    string: &#39;{http://www.opengis.net/ogc}&#39; +
                        &#39;ogc:Filter&#39;
                }
            };
        },

<span id='BasiGX-util-Filter-static-method-filterValuesToSimpleFilter'>        /**
</span>         * This method will be used to create simple filter without logical
         * operators and nesting.
         *
         * Output after marshalling via Jsonix could be e.g. as follows:
         *
         *     &lt;ogc:Filter xmlns:ogc=&#39;http://www.opengis.net/ogc&#39;
         *                 xmlns:gml=&#39;http://www.opengis.net/gml&#39;
         *                 xmlns:xsi=&#39;http://www.w3.org/2001/XMLSchema-instance&#39;
         *                 xmlns:xlink=&#39;http://www.w3.org/1999/xlink&#39;&gt;
         *         &lt;ogc:PropertyIsLike wildCard=&#39;*&#39; singleChar=&#39;%&#39; escape=&#39;!&#39;&gt;
         *             &lt;ogc:PropertyName&gt;neid&lt;/ogc:PropertyName&gt;
         *             &lt;ogc:Literal&gt;01VD2&lt;/ogc:Literal&gt;
         *         &lt;/ogc:PropertyIsLike&gt;
         *     &lt;/ogc:Filter&gt;
         *
         * @param {Object} filterValues A representation of filter values coming
         *     from our form for defining them.
         * @return {Object} An object representing a simple OGC filter 1.0.0;
         *     ready to be stringified using Jsonix.
         */
        filterValuesToSimpleFilter: function(filterValues) {
            var simpleFilter = {
                value: {
                    TYPE_NAME: &#39;Filter_1_0_0.FilterType&#39;,
                    comparisonOps: {
                        name: {
                            namespaceURI: &#39;http://www.opengis.net/ogc&#39;,
                            localPart: filterValues.operator,
                            prefix: &#39;ogc&#39;,
                            key: &#39;{http://www.opengis.net/ogc}&#39; +
                            filterValues.operator,
                            string: &#39;{http://www.opengis.net/ogc}ogc:&#39; +
                                filterValues.operator
                        },
                        value: {
                            TYPE_NAME: &#39;Filter_1_0_0.BinaryComparisonOpType&#39;,
                            expression: [{
                                name: {
                                    namespaceURI: &#39;http://www.opengis.net/ogc&#39;,
                                    localPart: &#39;PropertyName&#39;,
                                    prefix: &#39;ogc&#39;,
                                    key: &#39;{http://www.opengis.net/ogc}&#39; +
                                        &#39;PropertyName&#39;,
                                    string: &#39;{http://www.opengis.net/ogc}&#39; +
                                        &#39;ogc:PropertyName&#39;
                                },
                                value: {
                                    TYPE_NAME: &#39;Filter_1_0_0.PropertyNameType&#39;,
                                    content: [filterValues.attribute]
                                }
                            }, {
                                name: {
                                    namespaceURI: &#39;http://www.opengis.net/ogc&#39;,
                                    localPart: &#39;Literal&#39;,
                                    prefix: &#39;ogc&#39;,
                                    key: &#39;{http://www.opengis.net/ogc}Literal&#39;,
                                    string: &#39;{http://www.opengis.net/ogc}&#39; +
                                        &#39;ogc:Literal&#39;
                                },
                                value: {
                                    TYPE_NAME: &#39;Filter_1_0_0.LiteralType&#39;,
                                    content: [filterValues.filterValue]
                                }
                            }]
                        }
                    }
                },
                name: {
                    namespaceURI: &#39;http://www.opengis.net/ogc&#39;,
                    localPart: &#39;Filter&#39;,
                    prefix: &#39;ogc&#39;,
                    key: &#39;{http://www.opengis.net/ogc}Filter&#39;,
                    string: &#39;{http://www.opengis.net/ogc}&#39; +
                        &#39;ogc:Filter&#39;
                }
            };

            switch (filterValues.operator) {
                case &#39;PropertyIsEqualTo&#39;:
                    break;
                case &#39;PropertyIsNotEqualTo&#39;:
                    break;
                case &#39;PropertyIsBetween&#39;:
                    simpleFilter.value.comparisonOps.value = {
                        TYPE_NAME: &#39;Filter_1_0_0.PropertyIsBetweenType&#39;,
                        expression: {
                            name: {
                                namespaceURI: &#39;http://www.opengis.net/ogc&#39;,
                                localPart: &#39;PropertyName&#39;,
                                prefix: &#39;ogc&#39;,
                                key: &#39;{http://www.opengis.net/ogc}PropertyName&#39;,
                                string: &#39;{http://www.opengis.net/ogc}&#39; +
                                    &#39;ogc:PropertyName&#39;
                            },
                            value: {
                                TYPE_NAME: &#39;Filter_1_0_0.PropertyNameType&#39;,
                                content: [filterValues.attribute]
                            }
                        },
                        lowerBoundary: {
                            TYPE_NAME: &#39;Filter_1_0_0.LowerBoundaryType&#39;,
                            expression: {
                                name: {
                                    namespaceURI: &#39;http://www.opengis.net/ogc&#39;,
                                    localPart: &#39;Literal&#39;,
                                    prefix: &#39;ogc&#39;,
                                    key: &#39;{http://www.opengis.net/ogc}Literal&#39;,
                                    string: &#39;{http://www.opengis.net/ogc}&#39; +
                                        &#39;ogc:Literal&#39;
                                },
                                value: {
                                    TYPE_NAME: &#39;Filter_1_0_0.LiteralType&#39;,
                                    content: [filterValues
                                        .minBoundary.toString()]
                                }
                            }
                        },
                        upperBoundary: {
                            TYPE_NAME: &#39;Filter_1_0_0.UpperBoundaryType&#39;,
                            expression: {
                                name: {
                                    namespaceURI: &#39;http://www.opengis.net/ogc&#39;,
                                    localPart: &#39;Literal&#39;,
                                    prefix: &#39;ogc&#39;,
                                    key: &#39;{http://www.opengis.net/ogc}Literal&#39;,
                                    string: &#39;{http://www.opengis.net/ogc}&#39; +
                                        &#39;ogc:Literal&#39;
                                },
                                value: {
                                    TYPE_NAME: &#39;Filter_1_0_0.LiteralType&#39;,
                                    content: [filterValues
                                        .maxBoundary.toString()]
                                }
                            }
                        }
                    };
                    break;
                case &#39;PropertyIsLike&#39;:
                    simpleFilter.value.comparisonOps.value = {
                        TYPE_NAME: &#39;Filter_1_0_0.PropertyIsLikeType&#39;,
                        wildCard: &#39;*&#39;,
                        singleChar: &#39;%&#39;,
                        escape: &#39;!&#39;,
                        propertyName: {
                            TYPE_NAME: &#39;Filter_1_0_0.PropertyNameType&#39;,
                            content: [filterValues.attribute]
                        },
                        literal: {
                            TYPE_NAME: &#39;Filter_1_0_0.LiteralType&#39;,
                            content: [filterValues.filterValue]
                        }
                    };
                    break;
                case &#39;PropertyIsLessThan&#39;:
                case &#39;PropertyIsLessThanOrEqualTo&#39;:
                case &#39;PropertyIsGreaterThan&#39;:
                case &#39;PropertyIsGreaterThanOrEqualTo&#39;:
                    simpleFilter.value.comparisonOps.value.expression[1] = {
                        name: {
                            namespaceURI: &#39;http://www.opengis.net/ogc&#39;,
                            localPart: &#39;Literal&#39;,
                            prefix: &#39;ogc&#39;,
                            key: &#39;{http://www.opengis.net/ogc}Literal&#39;,
                            string: &#39;{http://www.opengis.net/ogc}ogc:Literal&#39;
                        },
                        value: {
                            TYPE_NAME: &#39;Filter_1_0_0.LiteralType&#39;,
                            content: [filterValues.filterValue]
                        }
                    };
                    break;
                default:
                    break;
            }
            return simpleFilter;
        },

<span id='BasiGX-util-Filter-static-method-filterValuesToLogicalFilter'>        /**
</span>         * This method will be used to create more complex nested filter
         * including logical operators AND and OR.
         *
         * **Note:** Multiple nesting is not supported yet.
         *
         * Output after marshalling via Jsonix could be e.g. as follows:
         *
         *     &lt;ogc:Filter xmlns:ogc=&#39;http://www.opengis.net/ogc&#39;
         *                 xmlns:gml=&#39;http://www.opengis.net/gml&#39;
         *                 xmlns:xsi=&#39;http://www.w3.org/2001/XMLSchema-instance&#39;
         *                 xmlns:xlink=&#39;http://www.w3.org/1999/xlink&#39;&gt;
         *         &lt;ogc:Or&gt;
         *             &lt;ogc:PropertyIsLike wildCard=&#39;*&#39;
         *                  singleChar=&#39;%&#39; escape=&#39;!&#39;&gt;
         *                 &lt;ogc:PropertyName&gt;neid&lt;/ogc:PropertyName&gt;
         *                 &lt;ogc:Literal&gt;02VD2&lt;/ogc:Literal&gt;
         *             &lt;/ogc:PropertyIsLike&gt;
         *             &lt;ogc:PropertyIsGreaterThanOrEqualTo&gt;
         *                 &lt;ogc:PropertyName&gt;cellid&lt;/ogc:PropertyName&gt;
         *                 &lt;ogc:Literal&gt;0&lt;/ogc:Literal&gt;
         *             &lt;/ogc:PropertyIsGreaterThanOrEqualTo&gt;
         *         &lt;/ogc:Or&gt;
         *     &lt;/ogc:Filter&gt;
         *
         * @param {Array} filterValuesArray An array of filter values coming
         *     from our form for defining them.
         * @param {String} logicalOp A string defining the logical operation
         *     used for the combination. Either `&#39;Or&#39;` or `&#39;And&#39;`.
         * @return {Object} A logically combining object with the passed filters
         *     that is ready to be serialized to a string by Jsonix.
         */
        filterValuesToLogicalFilter: function(filterValuesArray, logicalOp) {
            var filterUtil = BasiGX.util.Filter;
            var logicalFilter = {
                name: {
                    namespaceURI: &#39;http://www.opengis.net/ogc&#39;,
                    localPart: &#39;Filter&#39;,
                    prefix: &#39;ogc&#39;,
                    key: &#39;{http://www.opengis.net/ogc}Filter&#39;,
                    string: &#39;{http://www.opengis.net/ogc}&#39; +
                        &#39;ogc:Filter&#39;
                },
                value: {
                    TYPE_NAME: &#39;Filter_1_0_0.FilterType&#39;,
                    logicOps: {
                        name: {
                            namespaceURI: &#39;http://www.opengis.net/ogc&#39;,
                            localPart: logicalOp,
                            prefix: &#39;ogc&#39;,
                            key: &#39;{http://www.opengis.net/ogc}&#39; + logicalOp,
                            string: &#39;{http://www.opengis.net/ogc}ogc:&#39;
                                + logicalOp
                        },
                        value: {
                            TYPENAME: &#39;Filter_1_0_0.BinaryLogicOpType&#39;,
                            ops: []
                        }
                    }
                }
            };

            Ext.each(filterValuesArray, function(filterValues) {
                var simpleFilter =
                    filterUtil.filterValuesToSimpleFilter(filterValues);

                logicalFilter.value.logicOps.value.ops.push(
                    simpleFilter.value.comparisonOps
                );
            });
            return logicalFilter;
        },

<span id='BasiGX-util-Filter-static-method-filterGeometryToIntersectionFilter'>        /**
</span>         * This method will be used to create simple spatial filter (e.g. for
         * INTERSECT, CONTAIN or OVERLAP operations). Currently only INTERSECT
         * filter will be supported.
         * Output after marshalling via Jsonix could be e.g. as follows:
         *
         *    &lt;ogc:Filter xmlns:ogc=&#39;http://www.opengis.net/ogc&#39;
         *                xmlns:gml=&#39;http://www.opengis.net/gml&#39;
         *                xmlns:xsi=&#39;http://www.w3.org/2001/XMLSchema-instance&#39;
         *                xmlns:xlink=&#39;http://www.w3.org/1999/xlink&#39;
         *                xmlns:ows=&#39;http://www.opengis.net/ows/1.1&#39;
         *                xmlns:wps=&#39;http://www.opengis.net/wps/1.0.0&#39;&gt;
         *       &lt;ogc:Intersects&gt;
         *           &lt;ogc:PropertyName&gt;geom&lt;/ogc:PropertyName&gt;
         *           &lt;gml:Polygon srsName=&#39;EPSG:25832&#39;&gt;
         *               &lt;gml:exterior&gt;
         *                   &lt;gml:LinearRing&gt;
         *                       &lt;gml:posList&gt;
         *                            680504.3137212421 5639437.573
         *                            680498.5086607657 5639496.512768128
         *                            [...]
         *                            680504.3137212421 5639437.573
         *                        &lt;/gml:posList&gt;
         *                    &lt;/gml:LinearRing&gt;
         *                &lt;/gml:exterior&gt;
         *            &lt;/gml:Polygon&gt;
         *        &lt;/ogc:Intersects&gt;
         *    &lt;/ogc:Filter&gt;
         *
         *    @param {Array} geom Coordinates array
         *    @param {String} proj Projection string (e.g. EPSG:25832)
         *    @param {String} geomName Name of geometry column (e.g. geom)
         *    @param {String} geomType The geometry type
         *    @param {String} spatialOperator The spatial operator
         *    @return {String} The spatial filter
         */
        filterGeometryToIntersectionFilter: function(geom, proj, geomName,
            geomType, spatialOperator) {
            var ogcNsUri = &#39;http://www.opengis.net/ogc&#39;;
            var gmlNsUri = &#39;http://www.opengis.net/gml&#39;;
            var spatialFilter = {
                name: {
                    key: &#39;{&#39; + ogcNsUri + &#39;}Filter&#39;,
                    localPart: &#39;Filter&#39;,
                    namespaceURI: ogcNsUri,
                    prefix: &#39;ogc&#39;,
                    string: &#39;{&#39; + ogcNsUri + &#39;}Filter&#39;
                },
                value: {
                    TYPE_NAME: &#39;Filter_1_0_0.FilterType&#39;,
                    spatialOps: {
                        name: {
                            key: &#39;{&#39; + ogcNsUri + &#39;}&#39; + spatialOperator,
                            localPart: spatialOperator,
                            namespaceURI: ogcNsUri,
                            prefix: &#39;ogc&#39;,
                            string: &#39;{&#39; + ogcNsUri + &#39;}ogc:&#39; + spatialOperator
                        },
                        value: {
                            TYPENAME: &#39;Filter_1_0_0.BinarySpatialOpType&#39;,
                            geometry: {
                                name: {
                                    key: &#39;{&#39; + gmlNsUri + &#39;}&#39; + geomType,
                                    localPart: geomType,
                                    namespaceURI: gmlNsUri,
                                    prefix: &#39;gml&#39;,
                                    string: &#39;{&#39; + gmlNsUri + &#39;}gml:&#39; + geomType
                                },
                                value: {
                                    TYPE_NAME: &#39;GML_3_1_1.&#39; + geomType + &#39;Type&#39;,
                                    srsName: proj
                                }
                            },
                            propertyName: {
                                TYPE_NAME: &#39;Filter_1_0_0.PropertyNameType&#39;,
                                content: [geomName]
                            }
                        }
                    }
                }
            };

            switch (geomType) {
                case &#39;Polygon&#39;:
                    spatialFilter.value.spatialOps.value.geometry
                        .value.exterior = {
                            name: {
                                key: &#39;{&#39; + gmlNsUri + &#39;}exterior&#39;,
                                localPart: &#39;exterior&#39;,
                                namespaceURI: gmlNsUri,
                                prefix: &#39;gml&#39;,
                                string: &#39;{&#39; + gmlNsUri + &#39;}gml:exterior&#39;
                            },
                            value: {
                                TYPE_NAME: &#39;GML_3_1_1.AbstractRingPropertyType&#39;,
                                ring: {
                                    name: {
                                        key: &#39;{&#39; + gmlNsUri + &#39;}LinearRing&#39;,
                                        localPart: &#39;LinearRing&#39;,
                                        namespaceURI: gmlNsUri,
                                        prefix: &#39;gml&#39;,
                                        string: &#39;{&#39; + gmlNsUri +
                                            &#39;}gml:LinearRing&#39;
                                    },
                                    value: {
                                        TYPE_NAME: &#39;GML_3_1_1.LinearRingType&#39;,
                                        posList: {
                                            TYPE_NAME: &#39;GML_3_1_1.&#39; +
                                                &#39;DirectPositionListType&#39;,
                                            value: geom
                                        }
                                    }
                                }
                            }
                        };
                    break;
                case &#39;LineString&#39;:
                    spatialFilter.value.spatialOps.value.geometry.value = {
                        TYPE_NAME: &#39;GML_3_1_1.LineStringType&#39;,
                        posList: {
                            TYPE_NAME: &#39;GML_3_1_1.DirectPositionListType&#39;,
                            value: geom
                        }
                    };
                    break;
                default:
                    break;
            }

            return spatialFilter;
        }
    }
});
</pre>
</body>
</html>
