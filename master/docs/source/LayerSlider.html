<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">/* Copyright (c) 2015-present terrestris GmbH &amp; Co. KG
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
<span id='BasiGX-view-container-LayerSlider'>/**
</span> * Layer Slider
 *
 * Used to change opacity on multiple layers by fading them in and out
 * one by one. Can be useful e.g. to slide &#39;through the time&#39;
 *
 * Example usage:
 *
 * {
 *      xtype: &#39;basigx-slider-layer&#39;,
 *      layerNames: [
 *           &#39;Luftbilder 1936&#39;,
 *           &#39;Luftbilder 1971&#39;,
 *           &#39;Luftbilder 1999&#39;
 *      ],
 *      sliderTitles: [
 *           &#39;1936&#39;,
 *           &#39;1971&#39;,
 *           &#39;1999&#39;
 *      ],
 *      topTitle: &#39;Luftbilder&#39;,
 *      addOffState: false
 * }
 *
 * TODOs:
 *   * Handle problems that occur when layers are visible in tree and get
 *     checked / unchecked
 *   * Make the slider / label positioning more flexible / dynamic
 *
 * @class BasiGX.view.container.LayerSlider
 */
Ext.define(&#39;BasiGX.view.container.LayerSlider&#39;, {
    extend: &#39;Ext.container.Container&#39;,
    xtype: &#39;basigx-slider-layer&#39;,

    requires: [
        &#39;Ext.slider.Single&#39;
    ],

<span id='BasiGX-view-container-LayerSlider-property-viewModel'>    /**
</span>     *
     */
    viewModel: {
        data: {
            disabeldLabelHtml: &#39;Aus&#39;,
            documentation: &#39;&lt;h2&gt;LayerSlider&lt;/h2&gt;• Bewegen Sie den &#39; +
                &#39;Schieberegler, um die Darstellung von einem Kartenthem &#39; +
                &#39;zum nächsten in einem weichen Übergang darzustellen&#39;
        }
    },

<span id='BasiGX-view-container-LayerSlider-property-sliderConfig'>    /**
</span>     *
     */
    sliderConfig: {
        flex: 6,
        value: 0,
        minValue: 0,
        maxValue: 100,
        useTips: false
    },

<span id='BasiGX-view-container-LayerSlider-property-width'>    /**
</span>     *
     */
    width: 250,

<span id='BasiGX-view-container-LayerSlider-property-layers'>    /**
</span>     * Array gets filled with ol-layers by the given layernames
     */
    layers: [],

<span id='BasiGX-view-container-LayerSlider-property-sliderTitles'>    /**
</span>     * The titles for the layerslider items
     */
    sliderTitles: [],

<span id='BasiGX-view-container-LayerSlider-property-topTitle'>    /**
</span>     * the title appearing on top the slider
     */
    topTitle: null,

<span id='BasiGX-view-container-LayerSlider-property-addOffState'>    /**
</span>     * flag used to indicate that the slider should have an &quot;off&quot; state at the
     * beginning. When set to true, no slider-layer is initially visible
     */
    addOffState: true,

<span id='BasiGX-view-container-LayerSlider-property-initialActiveLayerIdx'>    /**
</span>     * The index of the layer that should be active on init.
     * Slider will get set to the desired value
     */
    initialActiveLayerIdx: 0,

<span id='BasiGX-view-container-LayerSlider-property-cls'>    /**
</span>     * the cls
     */
    cls: &#39;layerSlider&#39;,

<span id='BasiGX-view-container-LayerSlider-method-initComponent'>    /**
</span>     *
     */
    initComponent: function() {
        var me = this;
        var map = BasiGX.util.Map.getMapComponent().getMap();
        var labelItems = me.getLabelItems();
        var items = [];

        me.layers = [];

        if (Ext.isEmpty(me.layerNames) || me.layerNames.length &lt; 2) {
            Ext.log.error(&#39;Not enough layers given to slider!&#39;);
        } else {
            Ext.each(me.layerNames, function(ln) {
                me.addLayerByName(map.getLayers().getArray(), ln);
            });
        }
        if (me.layerNames.length !== me.layers.length) {
            Ext.log.error(&#39;Could not detect all layers by name!&#39;);
        }

        // set the colspan for slider
        me.config.colspan = me.addOffState ?
            me.layerNames.length + 1 : me.layerNames.length;
        var slider = Ext.create(&#39;Ext.slider.Single&#39;, me.sliderConfig);

        if (!Ext.isEmpty(me.topTitle)) {
            var titleContainer = {
                xtype: &#39;container&#39;,
                cls: &#39;sliderTopTitle&#39;,
                html: me.topTitle
            };
            items.push(titleContainer);
        }

        var labelContainer = {
            xtype: &#39;container&#39;,
            layout: {
                type: &#39;hbox&#39;,
                align: &#39;stretch&#39;
            },
            items: labelItems
        };
        items.push(labelContainer);

        var sliderContainer = {
            xtype: &#39;container&#39;,
            layout: {
                type: &#39;hbox&#39;,
                align: &#39;stretch&#39;
            },
            items: [
                {
                    xtype: &#39;container&#39;,
                    flex: 1
                },
                slider,
                {
                    xtype: &#39;container&#39;,
                    flex: 1
                }
            ]
        };
        items.push(sliderContainer);

        me.items = items;

        me.callParent();

        slider.on(&#39;change&#39;, me.changeHandler);

        if (me.initialActiveLayerIdx &gt; 0) {
            var sliderVal = slider.maxValue / (
                me.addOffState ? me.layers.length : me.layers.length - 1) *
                me.initialActiveLayerIdx;
            slider.setValue(sliderVal);
            slider.fireEvent(&#39;change&#39;, slider, sliderVal);
        }
    },

<span id='BasiGX-view-container-LayerSlider-method-getLabelItems'>    /**
</span>     * Returns the label items.
     *
     * @return {Array&lt;Object&gt;} The label items.
     */
    getLabelItems: function() {
        var me = this;
        var labelItems = [];

        if (me.addOffState) {
            // add the starter
            labelItems.push(
                {
                    xtype: &#39;container&#39;,
                    bind: {
                        html: &#39;{disabeldLabelHtml}&#39;
                    },
                    flex: 1,
                    cls: &#39;sliderLabel&#39;
                }
            );
        }

        Ext.each(me.sliderTitles, function(title) {
            labelItems.push({
                xtype: &#39;container&#39;,
                html: title,
                flex: 1,
                cls: &#39;sliderLabel&#39;
            });
        });
        return labelItems;
    },

<span id='BasiGX-view-container-LayerSlider-method-addLayerByName'>    /**
</span>     * Adds layers to a member variable by the given layernames.
     *
     * @param {ol.Collection} collection The collection to add the layer with
     *     the passed name to.
     * @param {String} ln The name of the layer to search and then add to the
     *     collection.
     */
    addLayerByName: function(collection, ln) {
        var me = this;
        Ext.each(collection, function(layer, idx) {
            if (layer.get(&#39;name&#39;) === ln) {
                if (!me.addOffState &amp;&amp; idx === 0) {
                    // we have to set the first layer initially full visible
                    layer.set(&#39;opacity&#39;, 1);
                    layer.setVisible(true);
                } else {
                    // with addOffState, first layer must be opaque
                    layer.set(&#39;opacity&#39;, 0);
                    layer.setVisible(false);
                }
                layer.set(&#39;isSliderLayer&#39;, true);
                me.layers.push(layer);
                return false;
            }
            if (layer instanceof ol.layer.Group) {
                me.addLayerByName(layer.getLayers().getArray(), ln);
            }
        });
    },

<span id='BasiGX-view-container-LayerSlider-method-changeHandler'>    /**
</span>     * Handling the opacity change on the configured layers.
     *
     * TODO This method should be rewritten with readability in mind.
     *
     * @param {Ext.slider.Slider} slider The slider.
     * @param {Number} value The position of the slider as number between
     *     `minValue` and `maxValue` of the slider.
     */
    changeHandler: function(slider, value) {
        var sliderContainer = this.up(&#39;basigx-slider-layer&#39;);
        var layers = sliderContainer.layers;
        var numLayers = layers.length;
        var swapRange = slider.maxValue / (
            sliderContainer.addOffState ? numLayers : numLayers - 1
        );

        if (value === slider.maxValue) {
            // maxValue breaks mathematics so we use maxValue -1;
            value = slider.maxValue - 1;
        }
        var idx = parseInt(value / swapRange, 10);

        // disable all layers in order to avoid unnecessary requests and
        // gain performance. enable required ones later...
        Ext.each(layers, function(layer) {
            layer.setVisible(false);
        });

        if (value &gt;= swapRange || !sliderContainer.addOffState) {
            // need to break down the value to the corresponding range.
            // with e.g. 4 layers this will always be between 0 and 25
            value = value - swapRange * idx;

            if (!sliderContainer.addOffState) {
                sliderContainer.layers[idx].set(&#39;opacity&#39;, Math.abs(1 -
                        (value * layers.length / 100)));
                sliderContainer.layers[idx + 1].set(&#39;opacity&#39;,
                    value * layers.length / 100);

                sliderContainer.layers[idx].setVisible(true);
                sliderContainer.layers[idx + 1].setVisible(true);
            } else {
                sliderContainer.layers[idx - 1].set(&#39;opacity&#39;, Math.abs(1 -
                        (value * layers.length / 100)));
                sliderContainer.layers[idx].set(&#39;opacity&#39;,
                    value * layers.length / 100);

                sliderContainer.layers[idx - 1].setVisible(true);
                sliderContainer.layers[idx].setVisible(true);
            }
        } else {
            // we are on the first slide part and have an offState,
            // just fade in the first layer
            sliderContainer.layers[idx].set(&#39;opacity&#39;,
                value * layers.length / 100);
            sliderContainer.layers[idx].setVisible(true);
        }
    }
});
</pre>
</body>
</html>
